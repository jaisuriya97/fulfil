services:
  # 1. The PostgreSQL Database
  - type: postgres
    name: product-db
    plan: free

  # 2. The Redis Instance
  - type: redis
    name: product-broker
    plan: free

  # 3. The Flask/SocketIO Web Service (API)
  - type: web
    name: product-importer-api
    plan: free
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    healthCheck:
      path: /api/health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: product-db
          property: postgresql://product_db_sc3n_user:YjAahS7nv24nPZ0bI2GzSnRwdUOnAFZi@dpg-d4bmcp24d50c73cm3800-a/product_db_sc3n
      - key: REDIS_URL
        fromService:
          name: product-broker
          property: postgresql://product_db_sc3n_user:YjAahS7nv24nPZ0bI2GzSnRwdUOnAFZi@dpg-d4bmcp24d50c73cm3800-a/product_db_sc3n
      - key: SECRET_KEY
        generateValue: true # Auto-generated by Render
      - key: PYTHONUNBUFFERED
        value: 1

  # 4. The Celery Background Worker
  - type: worker
    name: product-importer-worker
    plan: free
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: product-db
          property: internalConnectionString
      - key: REDIS_URL
        fromService:
          name: product-broker
          property: internalConnectionString
      - key: PYTHONUNBUFFERED
        value: 1
    startCommand: "celery -A celery_app.celery worker --loglevel=info"

  # 5. The React Static Site (UI)
  - type: static
    name: product-importer-ui
    plan: free
    buildCommand: "npm install && npm run build"
    publishPath: ./frontend/build
    routes:
      - type: rewrite
        source: /*
        destination: /index.html